# Universal scash miner installer for Windows
# Usage: Run PowerShell as Administrator, then:
#        iex (iwr -useb https://raw.githubusercontent.com/Don-Yin/miner/main/scripts/scash/install-windows).Content

Write-Host "detected platform: windows"
Write-Host ""

# Check if running as Administrator
$isAdmin = ([Security.Principal.WindowsPrincipal] [Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole([Security.Principal.WindowsBuiltInRole]::Administrator)

# Enable Large Pages (requires admin)
if ($isAdmin) {
    Write-Host "enabling large pages support..." -ForegroundColor Cyan
    $username = [System.Security.Principal.WindowsIdentity]::GetCurrent().Name
    
    # Grant SeLockMemoryPrivilege using ntrights.exe method or secedit
    try {
        # Export current security policy
        secedit /export /cfg "$env:TEMP\secpol.cfg" | Out-Null
        
        # Read and modify policy
        $content = Get-Content "$env:TEMP\secpol.cfg"
        $lockMemoryLine = $content | Where-Object { $_ -match "SeLockMemoryPrivilege" }
        
        if ($lockMemoryLine) {
            # Add user to existing policy
            $content = $content -replace "(SeLockMemoryPrivilege\s*=\s*)(.*)", "`$1`$2,$username"
        } else {
            # Create new policy line
            $content += "`r`nSeLockMemoryPrivilege = $username"
        }
        
        # Write and apply new policy
        $content | Set-Content "$env:TEMP\secpol_new.cfg"
        secedit /configure /db secedit.sdb /cfg "$env:TEMP\secpol_new.cfg" /areas USER_RIGHTS | Out-Null
        Remove-Item "$env:TEMP\secpol.cfg", "$env:TEMP\secpol_new.cfg" -ErrorAction SilentlyContinue
        
        Write-Host "large pages privilege granted successfully" -ForegroundColor Green
        Write-Host "NOTE: You may need to log out and log back in for changes to take effect" -ForegroundColor Yellow
    } catch {
        Write-Host "automatic configuration failed" -ForegroundColor Red
        Write-Host "please enable manually: secpol.msc -> Local Policies -> User Rights Assignment -> Lock pages in memory" -ForegroundColor Yellow
    }
    Write-Host ""
} else {
    Write-Host "WARNING: Not running as Administrator!" -ForegroundColor Red
    Write-Host "Large pages will NOT work without admin privileges" -ForegroundColor Red
    Write-Host "Please close this window and run PowerShell as Administrator" -ForegroundColor Yellow
    Write-Host ""
    Read-Host "Press Enter to continue anyway (will mine at half speed)"
}

# Download and extract srbminer if not present
if (!(Test-Path "SRBMiner-Multi-3-0-2")) {
    Write-Host "downloading srbminer..."
    Invoke-WebRequest -Uri "https://github.com/doktor83/SRBMiner-Multi/releases/download/3.0.2/SRBMiner-Multi-3-0-2-win64.zip" -OutFile "srbminer.zip"
    Write-Host "extracting srbminer..."
    Expand-Archive -Path "srbminer.zip" -DestinationPath "."
    Remove-Item "srbminer.zip"
}

# Start mining
$worker = "windows-cpu-$($env:NUMBER_OF_PROCESSORS)-$(Get-Date -Format 'MM-dd-HH-mm')"
Write-Host "starting miner with worker: $worker"
Write-Host ""

& "SRBMiner-Multi-3-0-2\SRBMiner-MULTI.exe" --algorithm randomscash --pool scash.work:8888 --wallet scash1q8pjehs7k56xm04jsg77d7quhnx2y8s3dhkaynv --worker $worker --enable-large-pages

Write-Host ""
Write-Host "installation complete!" -ForegroundColor Green
Write-Host "miner running on port 8888" -ForegroundColor Cyan

